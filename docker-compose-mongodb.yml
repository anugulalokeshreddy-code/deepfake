version: '3.8'

services:
  deepfake-web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vit-deepfake-detector
    ports:
      - "5000:5000"
    environment:
      FLASK_ENV: development
      FLASK_APP: backend/app_mongo_enabled.py
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-production}
      
      # Database Configuration (choose one)
      DB_TYPE: ${DB_TYPE:-sqlite}
      DATABASE_URL: ${DATABASE_URL:-sqlite:///users.db}
      MONGODB_URI: ${MONGODB_URI:-mongodb://mongodb:27017/deepfake_detector}
      MONGODB_DB: ${MONGODB_DB:-deepfake_detector}
      
      # Model and File Configuration
      MODEL_PATH: models/vit_deepfake_detector.pth
      UPLOAD_FOLDER: backend/uploads
      MAX_CONTENT_LENGTH: 16777216
      DEVICE: ${DEVICE:-cpu}
      
    volumes:
      - ./backend/uploads:/app/backend/uploads
      - ./models:/app/models
    
    depends_on:
      - mongodb  # Only needed if DB_TYPE=mongodb
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    networks:
      - deepfake-network

  # MongoDB service (optional - enable when DB_TYPE=mongodb)
  mongodb:
    image: mongo:7.0
    container_name: vit-deepfake-mongodb
    
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-password}
      MONGO_INITDB_DATABASE: deepfake_detector
    
    ports:
      - "27017:27017"
    
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    
    restart: unless-stopped
    
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    
    networks:
      - deepfake-network
    
    # Profiles: 'dev' uses MongoDB, 'sqlite' uses SQLite only
    profiles:
      - mongodb
      - all

  # MongoDB Express (optional web UI for MongoDB)
  mongodb-express:
    image: mongo-express:latest
    container_name: vit-deepfake-mongo-express
    
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${MONGO_USER:-admin}
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGO_PASSWORD:-password}
      ME_CONFIG_MONGODB_URL: mongodb://${MONGO_USER:-admin}:${MONGO_PASSWORD:-password}@mongodb:27017/
      ME_CONFIG_BASICAUTH_USERNAME: ${MONGO_EXPRESS_USER:-admin}
      ME_CONFIG_BASICAUTH_PASSWORD: ${MONGO_EXPRESS_PASSWORD:-admin}
    
    ports:
      - "8081:8081"
    
    depends_on:
      - mongodb
    
    restart: unless-stopped
    
    networks:
      - deepfake-network
    
    profiles:
      - mongodb-ui
      - all

  # Nginx reverse proxy (optional, for production)
  nginx:
    image: nginx:alpine
    container_name: vit-deepfake-nginx
    
    ports:
      - "80:80"
      - "443:443"
    
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    
    depends_on:
      - deepfake-web
    
    restart: unless-stopped
    
    networks:
      - deepfake-network
    
    profiles:
      - prod
      - prod-mongodb

volumes:
  mongodb_data:
  mongodb_config:
  uploads_data:
  models_data:

networks:
  deepfake-network:
    driver: bridge
